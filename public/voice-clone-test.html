<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音克隆功能测试</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-bottom: 1rem;
            color: #1e293b;
        }
        .status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-weight: 500;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.warning { background: #fef3c7; color: #d97706; }
        .status.info { background: #dbeafe; color: #2563eb; }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #5048e5;
            transform: translateY(-1px);
        }
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .audio-player {
            margin: 1rem 0;
        }
        .clone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin: 0.5rem 0;
        }
        .clone-info {
            flex: 1;
        }
        .clone-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fa fa-microphone"></i> 语音克隆功能测试</h1>
        
        <!-- 系统状态检查 -->
        <div class="test-section">
            <h3><i class="fa fa-heartbeat"></i> 系统状态检查</h3>
            <button class="test-button" onclick="checkSystemStatus()">检查系统状态</button>
            <div id="systemStatus"></div>
        </div>

        <!-- MiniMax配置检查 -->
        <div class="test-section">
            <h3><i class="fa fa-cog"></i> MiniMax配置检查</h3>
            <button class="test-button" onclick="checkMiniMaxConfig()">检查配置</button>
            <div id="configStatus"></div>
        </div>

        <!-- API权限测试 -->
        <div class="test-section">
            <h3><i class="fa fa-key"></i> API权限测试</h3>
            <button class="test-button" onclick="testAPIPermissions()">测试权限</button>
            <div id="permissionStatus"></div>
        </div>

        <!-- 语音克隆列表 -->
        <div class="test-section">
            <h3><i class="fa fa-list"></i> 语音克隆列表</h3>
            <button class="test-button" onclick="loadVoiceClones()">刷新列表</button>
            <div id="voiceClonesList"></div>
        </div>

        <!-- 语音合成测试 -->
        <div class="test-section">
            <h3><i class="fa fa-volume-up"></i> 语音合成测试</h3>
            <input type="text" id="testText" placeholder="输入测试文本..." value="你好，我是礼明老师，很高兴为您服务！" style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 1rem;">
            <br>
            <button class="test-button" onclick="testVoiceSynthesis()">测试语音合成</button>
            <button class="test-button" onclick="testWebSpeech()">测试Web Speech</button>
            <div id="synthesisResult"></div>
        </div>

        <!-- 快速修复工具 -->
        <div class="test-section">
            <h3><i class="fa fa-wrench"></i> 快速修复工具</h3>
            <button class="test-button" onclick="resetVoiceConfig()">重置语音配置</button>
            <button class="test-button" onclick="clearCache()">清除缓存</button>
            <button class="test-button" onclick="switchToWebSpeech()">切换到Web Speech</button>
            <div id="fixResult"></div>
        </div>
    </div>

    <script>
        // 系统状态检查
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">正在检查系统状态...</div>';
            
            try {
                const response = await fetch('/api/voice-config');
                const config = await response.json();
                
                let html = '<div class="status success">✅ 服务器运行正常</div>';
                html += `<div class="result-box">当前配置：\n${JSON.stringify(config, null, 2)}</div>`;
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 系统检查失败: ${error.message}</div>`;
            }
        }

        // MiniMax配置检查
        async function checkMiniMaxConfig() {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.innerHTML = '<div class="status info">正在检查MiniMax配置...</div>';
            
            try {
                const response = await fetch('/api/voice-config');
                const config = await response.json();
                
                let issues = [];
                let warnings = [];
                
                if (!config.apiKey) {
                    issues.push('缺少API密钥');
                } else if (config.apiKey.startsWith('eyJ')) {
                    issues.push('API密钥格式错误（JWT令牌，需要sk-开头的标准密钥）');
                } else if (!config.apiKey.startsWith('sk-')) {
                    warnings.push('API密钥格式可能不正确（建议使用sk-开头的密钥）');
                }
                
                if (!config.groupId) {
                    issues.push('缺少Group ID');
                }
                
                let html = '';
                if (issues.length === 0) {
                    html += '<div class="status success">✅ 配置检查通过</div>';
                } else {
                    html += '<div class="status error">❌ 配置存在问题:</div>';
                    issues.forEach(issue => {
                        html += `<div class="status error">• ${issue}</div>`;
                    });
                }
                
                warnings.forEach(warning => {
                    html += `<div class="status warning">⚠️ ${warning}</div>`;
                });
                
                html += `<div class="result-box">完整配置：\n${JSON.stringify(config, null, 2)}</div>`;
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 配置检查失败: ${error.message}</div>`;
            }
        }

        // API权限测试
        async function testAPIPermissions() {
            const statusDiv = document.getElementById('permissionStatus');
            statusDiv.innerHTML = '<div class="status info">正在测试API权限...</div>';
            
            try {
                // 测试语音合成
                const ttsResponse = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: '测试' })
                });
                
                let html = '';
                if (ttsResponse.ok) {
                    html += '<div class="status success">✅ 语音合成权限正常</div>';
                } else {
                    const errorData = await ttsResponse.json();
                    html += `<div class="status error">❌ 语音合成失败: ${errorData.error}</div>`;
                }
                
                // 测试语音列表获取
                const voicesResponse = await fetch('/api/voices');
                if (voicesResponse.ok) {
                    const voicesData = await voicesResponse.json();
                    html += '<div class="status success">✅ 语音列表获取正常</div>';
                    html += `<div class="status info">可用语音数量: ${voicesData.voices?.length || 0}</div>`;
                } else {
                    html += '<div class="status error">❌ 语音列表获取失败</div>';
                }
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 权限测试失败: ${error.message}</div>`;
            }
        }

        // 加载语音克隆列表
        async function loadVoiceClones() {
            const listDiv = document.getElementById('voiceClonesList');
            listDiv.innerHTML = '<div class="status info">正在加载语音克隆列表...</div>';
            
            try {
                const response = await fetch('/api/voice-clones');
                const data = await response.json();
                
                if (data.success && data.clones.length > 0) {
                    let html = '<div class="status success">✅ 找到语音克隆</div>';
                    data.clones.forEach(clone => {
                        html += `
                            <div class="clone-item">
                                <div class="clone-info">
                                    <strong>${clone.name}</strong> (${clone.id})
                                    <br>
                                    <small>创建时间: ${new Date(clone.created_time).toLocaleString()}</small>
                                    <br>
                                    <small>状态: ${clone.is_real_clone ? '真实克隆' : '本地样本'}</small>
                                </div>
                                <div class="clone-actions">
                                    <button class="test-button" onclick="testClone('${clone.id}', '${clone.name}')">测试</button>
                                    <button class="test-button" onclick="setAsDefault('${clone.id}', '${clone.name}')">设为默认</button>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<div class="status warning">⚠️ 没有找到语音克隆</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="status error">❌ 加载失败: ${error.message}</div>`;
            }
        }

        // 测试语音合成
        async function testVoiceSynthesis() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('synthesisResult');
            
            if (!text.trim()) {
                resultDiv.innerHTML = '<div class="status error">❌ 请输入测试文本</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status info">正在生成语音...</div>';
            
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    let html = '<div class="status success">✅ 语音生成成功</div>';
                    html += `<audio controls class="audio-player" style="width: 100%;">
                                <source src="${audioUrl}" type="audio/mpeg">
                                您的浏览器不支持音频播放
                             </audio>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div class="status error">❌ 语音生成失败: ${errorData.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ 请求失败: ${error.message}</div>`;
            }
        }

        // 测试Web Speech
        async function testWebSpeech() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('synthesisResult');
            
            if (!text.trim()) {
                resultDiv.innerHTML = '<div class="status error">❌ 请输入测试文本</div>';
                return;
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onstart = () => {
                    resultDiv.innerHTML = '<div class="status info">🔊 正在播放Web Speech语音...</div>';
                };
                
                utterance.onend = () => {
                    resultDiv.innerHTML = '<div class="status success">✅ Web Speech播放完成</div>';
                };
                
                utterance.onerror = (event) => {
                    resultDiv.innerHTML = `<div class="status error">❌ Web Speech错误: ${event.error}</div>`;
                };
                
                speechSynthesis.speak(utterance);
            } else {
                resultDiv.innerHTML = '<div class="status error">❌ 浏览器不支持Web Speech API</div>';
            }
        }

        // 测试特定克隆
        async function testClone(cloneId, cloneName) {
            try {
                await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: cloneId, 
                        voiceName: cloneName,
                        platform: 'custom-clone'
                    })
                });
                
                document.getElementById('testText').value = `你好，我是${cloneName}，这是语音克隆测试。`;
                testVoiceSynthesis();
            } catch (error) {
                alert('设置语音失败: ' + error.message);
            }
        }

        // 设为默认语音
        async function setAsDefault(cloneId, cloneName) {
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: cloneId, 
                        voiceName: cloneName,
                        platform: 'custom-clone'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`✅ 已设置"${cloneName}"为默认语音`);
                    checkSystemStatus();
                } else {
                    alert('❌ 设置失败: ' + data.error);
                }
            } catch (error) {
                alert('❌ 设置失败: ' + error.message);
            }
        }

        // 重置语音配置
        async function resetVoiceConfig() {
            const resultDiv = document.getElementById('fixResult');
            
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: 'female-yujie', 
                        voiceName: '御姐音（女）',
                        platform: 'minimax'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    resultDiv.innerHTML = '<div class="status success">✅ 语音配置已重置为默认设置</div>';
                } else {
                    resultDiv.innerHTML = `<div class="status error">❌ 重置失败: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ 重置失败: ${error.message}</div>`;
            }
        }

        // 清除缓存
        function clearCache() {
            const resultDiv = document.getElementById('fixResult');
            
            // 清除音频缓存
            speechSynthesis.cancel();
            
            // 清除页面缓存
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            resultDiv.innerHTML = '<div class="status success">✅ 缓存已清除</div>';
        }

        // 切换到Web Speech
        async function switchToWebSpeech() {
            const resultDiv = document.getElementById('fixResult');
            
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: 'web-speech', 
                        voiceName: 'Web Speech',
                        platform: 'web-speech'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    resultDiv.innerHTML = '<div class="status success">✅ 已切换到Web Speech模式</div>';
                } else {
                    resultDiv.innerHTML = `<div class="status error">❌ 切换失败: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ 切换失败: ${error.message}</div>`;
            }
        }

        // 页面加载时自动检查状态
        window.onload = function() {
            checkSystemStatus();
            loadVoiceClones();
        };
    </script>
</body>
</html> 